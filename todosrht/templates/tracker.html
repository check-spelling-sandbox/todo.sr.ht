{% extends "todo.html" %}
{% block title %}
<title>
  {{tracker.name}}
  &mdash;
  {{ cfg("sr.ht", "site-name") }} todo
</title>
{% endblock %}
{% block body %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <h2>
        {{ format_tracker_name(tracker) }}
        <small>
          <a
            href="/~{{tracker.owner.username}}/{{tracker.name}}/configure"
          >Configure</a>
        </small>
      </h2>
    </div>
  </div>
  <div class="row">
    <div class="col-md-4">
      {{ tracker.description | md }}
      {% if TicketAccess.submit in access %}
      <h3 style="margin-top: 1rem">Submit ticket</h3>
      <form method="POST" action="{{
          url_for(".tracker_submit_POST",
            owner="~" + tracker.owner.username,
            name=tracker.name
          )
        }}">
        <div class="form-group">
          <label for="title">Title</label>
          <input
             type="text"
             class="form-control {{ valid.cls("title") }}"
             maxlength="2048"
             id="title"
             name="title"
             autofocus
             value="{{ title or "" }}" />
          {{valid.summary("title")}}
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea
            class="form-control {{ valid.cls("description") }}"
            id="description"
            name="description"
            placeholder="Markdown supported"
            maxlength="16384"
            rows="5">{{ description or "" }}</textarea>
          {{valid.summary("description")}}
        </div>
        <button
          type="submit"
          class="btn btn-primary"
        >
          Submit
          <i class="fa fa-caret-right"></i>
        </button>
        <label class="form-check-label" style="margin-left: 2rem">
          <input
            class="form-check-input"
            type="checkbox"
            name="another"
            style="position: relative; top: 2px;"
            {% if another %}
            checked
            {% endif %}> Submit another?
        </label>
      </form>
      {# TODO
      <h3>Notifications</h3>
      {% if is_subscribed %}
      <p>You are receiving notifications for this tracker.</p>
      {% else %}
      <p>You are not receiving notifications for this tracker.</p>
      {% endif %}
      <form method="POST">
        <button class="btn btn-default" type="submit">
          {% if is_subscribed %}
          Disable notifications
          {% else %}
          Enable notifications
          {% endif %}
        </button>
      </form>
      #}
      {% else %}
      <hr />
      <p>You need to <a href="{{ oauth_url }}">log in</a> to submit tickets.</p>
      {% endif %}
    </div>
    <div class="col-md-8">
      <form>
        <input
          name="search"
          type="text"
          placeholder="Search tickets...     status:closed     order:updated     submitter:me"
          class="form-control"
          value="{{ search if search else "" }}" />
      </form>
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a
            class="nav-link {{ "active" if not search else "" }}"
            href="{{url_for(".tracker_GET",
                owner="~" + tracker.owner.username,
                name=tracker.name
              )}}">open tickets</a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link {{
              "active" if search == "status:closed" or search == "status:resolved" else ""
            }}" href="?search=status:closed">closed tickets</a>
        </li>
        {% if search and search != "status:closed" and search != "status:resolved" %}
        <li class="nav-item">
          <a class="nav-link active" href="?search={{ search }}">search results</a>
        </li>
        {% endif %}
      </ul>
      {% if len(tickets) %}
      <table class="table table-striped">
        <thead>
          <tr>
            <th style="width: 1px"></th>
            <th>Title</th>
            <th>Updated</th>
            <th>Submitter</th>
            <th style="width: 4rem; white-space: nowrap;"></th>
          </tr>
        </thead>
        <tbody>
          {% for ticket in tickets %}
          <tr>
            <td style="text-align: right"><a href="{{url_for("ticket.ticket_GET",
                owner="~" + tracker.owner.username,
                name=tracker.name,
                ticket_id=ticket.scoped_id)}}">#{{ticket.scoped_id}}</a></td>
            <td>{{ ticket.title }}</td>
            <td>{{ ticket.updated | date }}</td>
            <td><a href="{{url_for("ticket.ticket_GET",
                owner="~" + tracker.owner.username,
                name=tracker.name,
                ticket_id=ticket.scoped_id)}}">{{ ticket.submitter.username }}</a></td>
            {% if ticket.new_updates(current_user) %}
            <td style="text-align: center">
              {{ ticket.comments | length }}&nbsp;<span class="fa fa-fw fa-comments-o"></span>
            </td>
            {% else %}
            <td style="text-align: center">
              {{ ticket.comments | length }}&nbsp;<span class="fa fa-fw fa-comments"></span>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="alert alert-info">No tickets found for this search criteria.</div>
      {% endif %}
      {% if total_pages > 1 %}
      <div class="row">
        <div class="col-md-4">
        {% if page != 1 %}
          <a href="?page={{ page - 1 }}{{ '&search=' + search if search else '' }}">[previous]</a>
        {% endif %}
        </div>
        <div class="col-md-4 text-centered">
          [ {{ page }} / {{ total_pages }} ]
        </div>
        <div class="col-md-4 text-right">
        {% if page != total_pages %}
          <a href="?page={{ page + 1 }}{{ '&search=' + search if search else '' }}">[next]</a>
        {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
